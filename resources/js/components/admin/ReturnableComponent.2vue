<template>
    <main class="main-content" id="app">
        <div class="returnables-content">
            <!-- Header Section -->
            <div class="header-section">
                <div class="section-header">
                    <h2 style="margin: 0; color: #333">
                        <i class="fas fa-cube"></i>
                        Gestion des Produits avec Emballages
                    </h2>
                    <p
                        style="
                            margin: 0.5rem 0 0 0;
                            color: #666;
                            font-size: 0.9rem;
                        "
                    >
                        Remise et retour des produits consignés
                    </p>
                </div>
            </div>

            <!-- Controls Section -->
            <div class="controls-section">
                <div class="search-filters">
                    <div class="search-box">
                        <input
                            type="text"
                            v-model="searchQuery"
                            placeholder="Rechercher par client ou produit..."
                            class="search-input"
                        />
                        <i class="fas fa-search"></i>
                    </div>

                    <div class="filters-group">
                        <select v-model="filterClient" class="select-filter">
                            <option value="">Tous les clients</option>
                            <option
                                v-for="client in uniqueClients"
                                :key="client.id"
                                :value="client.id"
                            >
                                {{ client.name }}
                            </option>
                        </select>

                        <select v-model="filterStatus" class="select-filter">
                            <option value="">Tous les statuts</option>
                            <option value="pending">Non retourné</option>
                            <option value="partial">
                                Partiellement retourné
                            </option>
                            <option value="complete">
                                Complètement retourné
                            </option>
                        </select>

                        <select v-model="sortOption" class="select-filter">
                            <option>Date (récent)</option>
                            <option>Date (ancien)</option>
                            <option>Client (A-Z)</option>
                            <option>Quantité restante (croissant)</option>
                            <option>Quantité restante (décroissant)</option>
                        </select>
                    </div>
                </div>

                <div class="action-buttons">
                    <button
                        @click="openCreateTransactionModal"
                        class="btn-primary"
                    >
                        <i class="fas fa-plus-circle"></i>
                        Nouvelle Remise
                    </button>
                    <button @click="printAll" class="btn-secondary">
                        <i class="fas fa-print"></i>
                        Imprimer Tous
                    </button>
                </div>
            </div>

            <!-- Transactions List View -->
            <div class="table-container">
                <div class="table-wrapper">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Référence</th>
                                <th>Date Remise</th>
                                <th>Produits</th>
                                <th>Qté Remise</th>
                                <th>Qté Retournée</th>
                                <th>En Attente</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr
                                v-for="transaction in paginatedTransactions"
                                :key="transaction.id"
                                :class="getTransactionRowClass(transaction)"
                            >
                                <td data-label="Client">
                                    <strong>
                                        {{ transaction.client_name }}
                                    </strong>
                                </td>
                                <td data-label="Référence" class="reference">
                                    {{ transaction.reference }}
                                </td>
                                <td data-label="Date">
                                    {{ formatDate(transaction.date) }}
                                </td>
                                <td data-label="Produits">
                                    <span class="product-count-badge">
                                        {{
                                            getProductCountForTransaction(
                                                transaction.id,
                                            )
                                        }}
                                        produit(s)
                                    </span>
                                </td>
                                <td data-label="Qté Remise" class="qty-center">
                                    {{ getTotalQuantityGiven(transaction.id) }}
                                </td>
                                <td
                                    data-label="Qté Retournée"
                                    class="qty-center"
                                >
                                    {{
                                        getTotalQuantityReturned(transaction.id)
                                    }}
                                </td>
                                <td
                                    data-label="En Attente"
                                    class="qty-center pending-qty"
                                >
                                    {{
                                        getTotalQuantityPending(transaction.id)
                                    }}
                                </td>
                                <td data-label="Statut">
                                    <span
                                        :style="
                                            getTransactionStatusBadgeStyle(
                                                transaction,
                                            )
                                        "
                                    >
                                        {{
                                            getTransactionStatusText(
                                                transaction,
                                            )
                                        }}
                                    </span>
                                </td>
                                <td data-label="Actions" class="actions-cell">
                                    <button
                                        @click="openDetailsModal(transaction)"
                                        class="btn-small btn-eye"
                                        title="Voir détails"
                                    >
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button
                                        @click="
                                            openRecordReturnModal(transaction)
                                        "
                                        class="btn-small btn-reply"
                                        title="Enregistrer retour"
                                    >
                                        <i class="fas fa-reply"></i>
                                    </button>
                                    <button
                                        @click="printTransaction(transaction)"
                                        class="btn-small btn-print"
                                        title="Imprimer"
                                    >
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button
                                        @click="openDeleteModal(transaction)"
                                        class="btn-small btn-delete"
                                        title="Supprimer"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr
                                v-if="paginatedTransactions.length === 0"
                                class="empty-row"
                            >
                                <td
                                    colspan="9"
                                    style="
                                        text-align: center;
                                        padding: 2rem;
                                        color: #999;
                                    "
                                >
                                    <i
                                        class="fas fa-inbox"
                                        style="
                                            font-size: 2rem;
                                            margin-bottom: 0.5rem;
                                        "
                                    ></i>
                                    <p>Aucune opération trouvée</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" v-if="totalPages > 1">
                    <button
                        @click="currentPage = Math.max(1, currentPage - 1)"
                        :disabled="currentPage === 1"
                        class="btn-pagination"
                    >
                        <i class="fas fa-chevron-left"></i>
                        Précédent
                    </button>
                    <span class="pagination-info">
                        Page {{ currentPage }} / {{ totalPages }}
                    </span>
                    <button
                        @click="
                            currentPage = Math.min(totalPages, currentPage + 1)
                        "
                        :disabled="currentPage === totalPages"
                        class="btn-pagination"
                    >
                        Suivant
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Modal: Nouvelle Remise de Produits -->
            <div
                v-if="showCreateModal"
                class="modal-overlay"
                @click.self="closeCreateModal"
            >
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h5>
                            <i class="fas fa-plus-circle"></i>
                            Nouvelle Remise de Produits avec Emballages
                        </h5>
                        <button @click="closeCreateModal" class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="submitNewTransaction">
                            <!-- Client Selection -->
                            <div class="form-section">
                                <h4 style="margin-bottom: 1rem; color: #333">
                                    Information Client
                                </h4>
                                <div class="form-group">
                                    <label>Sélectionner le client *</label>
                                    <div class="customer-search-container">
                                        <input
                                            type="text"
                                            class="form-control"
                                            v-model="
                                                newTransaction.customerSearch
                                            "
                                            @input="
                                                filterNewTransactionCustomers
                                            "
                                            @focus="
                                                showNewCustomerDropdown = true
                                            "
                                            placeholder="Rechercher un client..."
                                            required
                                        />
                                        <div
                                            v-if="
                                                showNewCustomerDropdown &&
                                                filteredNewCustomers.length > 0
                                            "
                                            class="customer-dropdown"
                                        >
                                            <div
                                                v-for="client in filteredNewCustomers"
                                                :key="client.id"
                                                @click="
                                                    selectNewTransactionCustomer(
                                                        client,
                                                    )
                                                "
                                                class="customer-dropdown-item"
                                            >
                                                <div class="customer-item-name">
                                                    {{ client.name }}
                                                </div>
                                                <div
                                                    class="customer-item-phone"
                                                >
                                                    {{ client.phone }}
                                                </div>
                                            </div>
                                        </div>

                                        <button
                                            v-if="
                                                newTransaction.customerSearch &&
                                                !newTransaction.selectedClient &&
                                                filteredNewCustomers.length ===
                                                    0
                                            "
                                            type="button"
                                            @click="openCreateCustomerModal"
                                            class="btn-create-customer"
                                        >
                                            <i class="fas fa-plus"></i>
                                            Créer "{{
                                                newTransaction.customerSearch
                                            }}"
                                        </button>
                                    </div>
                                </div>

                                <div
                                    v-if="newTransaction.selectedClient"
                                    class="selected-client-info"
                                >
                                    <div class="info-item">
                                        <span class="info-label">Client :</span>
                                        <span class="info-value">
                                            {{
                                                newTransaction.selectedClient
                                                    .name
                                            }}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">
                                            Téléphone :
                                        </span>
                                        <span class="info-value">
                                            {{
                                                newTransaction.selectedClient
                                                    .phone
                                            }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Products Selection -->
                            <div
                                class="form-section"
                                v-if="newTransaction.selectedClient"
                            >
                                <h4 style="margin-bottom: 1rem; color: #333">
                                    Sélection des Produits avec Emballages
                                </h4>

                                <div class="products-list">
                                    <div
                                        v-for="(
                                            line, index
                                        ) in newTransaction.productLines"
                                        :key="index"
                                        class="product-line-form"
                                    >
                                        <div class="product-line-header">
                                            <span class="line-number">
                                                Produit {{ index + 1 }}
                                            </span>
                                            <button
                                                v-if="index > 0"
                                                type="button"
                                                @click="
                                                    removeProductLine(index)
                                                "
                                                class="btn-remove-line"
                                            >
                                                <i class="fas fa-times"></i>
                                                Supprimer
                                            </button>
                                        </div>

                                        <!-- Product Selection with Search -->
                                        <div class="form-group">
                                            <label>
                                                Produit avec emballage *
                                            </label>
                                            <div
                                                class="product-search-container"
                                            >
                                                <input
                                                    type="text"
                                                    class="form-control product-search-input"
                                                    v-model="line.searchQuery"
                                                    @input="
                                                        onProductSearch(index)
                                                    "
                                                    @focus="
                                                        line.showDropdown = true
                                                    "
                                                    placeholder="Rechercher un produit..."
                                                    required
                                                />
                                                <div
                                                    v-if="
                                                        line.showDropdown &&
                                                        getFilteredReturnableProducts(
                                                            index,
                                                        ).length > 0
                                                    "
                                                    class="product-dropdown"
                                                >
                                                    <div
                                                        v-for="product in getFilteredReturnableProducts(
                                                            index,
                                                        )"
                                                        :key="product.id"
                                                        @click="
                                                            selectProductForLine(
                                                                index,
                                                                product,
                                                            )
                                                        "
                                                        class="product-dropdown-item"
                                                    >
                                                        <div
                                                            class="product-item-name"
                                                        >
                                                            {{ product.name }}
                                                        </div>
                                                        <div
                                                            class="product-item-stock"
                                                        >
                                                            Stock:
                                                            {{
                                                                product.quantity
                                                            }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Quantity -->
                                        <div
                                            class="form-group"
                                            v-if="line.selectedProduct"
                                        >
                                            <label>Quantité à remettre *</label>
                                            <div class="quantity-input-group">
                                                <input
                                                    type="number"
                                                    class="form-control quantity-input"
                                                    v-model.number="
                                                        line.quantity
                                                    "
                                                    min="0.01"
                                                    step="0.01"
                                                    :max="
                                                        line.selectedProduct
                                                            .quantity
                                                    "
                                                    placeholder="Quantité"
                                                    required
                                                />
                                                <span class="quantity-info">
                                                    Stock disponible:
                                                    {{
                                                        line.selectedProduct
                                                            .quantity
                                                    }}
                                                </span>
                                            </div>
                                        </div>

                                        <hr
                                            v-if="
                                                index <
                                                newTransaction.productLines
                                                    .length -
                                                    1
                                            "
                                            style="
                                                margin: 1.5rem 0;
                                                border: none;
                                                border-top: 1px solid #ddd;
                                            "
                                        />
                                    </div>
                                </div>

                                <button
                                    type="button"
                                    @click="addProductLine"
                                    class="btn-add-line"
                                >
                                    <i class="fas fa-plus"></i>
                                    Ajouter un produit
                                </button>
                            </div>

                            <!-- Comment -->
                            <div
                                class="form-section"
                                v-if="newTransaction.selectedClient"
                            >
                                <div class="form-group">
                                    <label>Commentaire</label>
                                    <textarea
                                        v-model="newTransaction.comment"
                                        class="form-control"
                                        rows="3"
                                        placeholder="Remarques supplémentaires..."
                                    ></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeCreateModal" class="btn-secondary">
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                        <button
                            @click="submitNewTransaction"
                            :disabled="!canSubmitNewTransaction"
                            class="btn-primary"
                        >
                            <i class="fas fa-save"></i>
                            Enregistrer la Remise
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal: Détails Complets de la Transaction -->
            <div
                v-if="showDetailsModal"
                class="modal-overlay"
                @click.self="closeDetailsModal"
            >
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h5>
                            <i class="fas fa-file-invoice-dollar"></i>
                            Détails de la Remise -
                            {{ selectedTransaction?.reference }}
                        </h5>
                        <button @click="closeDetailsModal" class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" v-if="selectedTransaction">
                        <!-- Header Info -->
                        <div class="details-header">
                            <div class="detail-group">
                                <div class="detail-item">
                                    <span class="detail-label">Client :</span>
                                    <span class="detail-value">
                                        {{ selectedTransaction.client_name }}
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">
                                        Référence :
                                    </span>
                                    <span class="detail-value">
                                        {{ selectedTransaction.reference }}
                                    </span>
                                </div>
                            </div>
                            <div class="detail-group">
                                <div class="detail-item">
                                    <span class="detail-label">Date :</span>
                                    <span class="detail-value">
                                        {{
                                            formatDate(selectedTransaction.date)
                                        }}
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">
                                        Commentaire :
                                    </span>
                                    <span class="detail-value">
                                        {{
                                            selectedTransaction.comment || 'N/A'
                                        }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Products Table -->
                        <div class="details-table-section">
                            <h4 style="margin-bottom: 1rem; color: #333">
                                Produits Remis
                            </h4>
                            <table class="details-table">
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Remis</th>
                                        <th>Retourné</th>
                                        <th>En Attente</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr
                                        v-for="product in getProductsForTransaction(
                                            selectedTransaction.id,
                                        )"
                                        :key="product.id"
                                    >
                                        <td>
                                            {{
                                                getProductName(
                                                    product.product_id,
                                                )
                                            }}
                                        </td>
                                        <td class="qty-center">
                                            {{ product.quantity_given }}
                                        </td>
                                        <td class="qty-center">
                                            {{ product.quantity_returned }}
                                        </td>
                                        <td class="qty-center pending-qty">
                                            {{
                                                product.quantity_given -
                                                product.quantity_returned
                                            }}
                                        </td>
                                        <td>
                                            <span
                                                :style="
                                                    getProductStatusBadgeStyle(
                                                        product,
                                                    )
                                                "
                                            >
                                                {{
                                                    getProductStatusText(
                                                        product,
                                                    )
                                                }}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Returns History -->
                        <div
                            class="details-table-section"
                            v-if="
                                getReturnsForTransaction(selectedTransaction.id)
                                    .length > 0
                            "
                        >
                            <h4 style="margin-bottom: 1rem; color: #333">
                                Historique des Retours
                            </h4>
                            <table class="details-table">
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Quantité Retournée</th>
                                        <th>Date de Retour</th>
                                        <th>Commentaire</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr
                                        v-for="returnItem in getReturnsForTransaction(
                                            selectedTransaction.id,
                                        )"
                                        :key="returnItem.id"
                                    >
                                        <td>
                                            {{
                                                getProductName(
                                                    returnItem.product_id,
                                                )
                                            }}
                                        </td>
                                        <td class="qty-center">
                                            {{ returnItem.quantity_returned }}
                                        </td>
                                        <td>
                                            {{ formatDate(returnItem.date) }}
                                        </td>
                                        <td>{{ returnItem.comment || '-' }}</td>
                                        <td class="actions-cell">
                                            <button
                                                @click="
                                                    openEditReturnModal(
                                                        returnItem,
                                                    )
                                                "
                                                class="btn-small btn-action"
                                                title="Modifier"
                                            >
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button
                                                @click="
                                                    openDeleteReturnModal(
                                                        returnItem,
                                                    )
                                                "
                                                class="btn-small btn-danger"
                                                title="Supprimer"
                                            >
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button
                            @click="closeDetailsModal"
                            class="btn-secondary"
                        >
                            <i class="fas fa-times"></i>
                            Fermer
                        </button>
                        <button
                            @click="printTransaction(selectedTransaction)"
                            class="btn-primary"
                        >
                            <i class="fas fa-print"></i>
                            Imprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal d'enregistrement des retours amélioré avec sélection des produits via checkbox -->
            <div
                v-if="showReturnModal"
                class="modal-overlay"
                @click.self="closeReturnModal"
            >
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h5>
                            <i class="fas fa-reply"></i>
                            Enregistrer les Retours
                        </h5>
                        <button @click="closeReturnModal" class="modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" v-if="selectedTransaction">
                        <div class="return-info-section">
                            <div class="info-item">
                                <span class="info-label">Client :</span>
                                <span class="info-value">
                                    {{ selectedTransaction.client_name }}
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Référence :</span>
                                <span class="info-value">
                                    {{ selectedTransaction.reference }}
                                </span>
                            </div>
                        </div>

                        <!-- Liste des produits avec sélection et quantité -->
                        <div class="products-for-return">
                            <h4 style="margin-bottom: 1rem; color: #333">
                                Sélectionner les Produits Retournés
                            </h4>

                            <div
                                v-if="
                                    getProductsForReturn(selectedTransaction.id)
                                        .length === 0
                                "
                                class="no-products-message"
                            >
                                <i class="fas fa-check-circle"></i>
                                <p>
                                    Tous les produits ont déjà été retournés
                                    pour cette transaction.
                                </p>
                            </div>

                            <div
                                v-for="product in getProductsForReturn(
                                    selectedTransaction.id,
                                )"
                                :key="product.id"
                                class="return-product-item"
                                :class="{
                                    selected:
                                        returnData[product.id] &&
                                        returnData[product.id].selected,
                                }"
                            >
                                <div class="product-selection-row">
                                    <!-- Checkbox pour sélectionner le produit -->
                                    <label class="checkbox-container">
                                        <input
                                            type="checkbox"
                                            v-model="
                                                returnData[product.id].selected
                                            "
                                            @change="
                                                onProductSelectionChange(
                                                    product.id,
                                                )
                                            "
                                        />
                                        <span class="checkmark"></span>
                                    </label>

                                    <div class="product-info-block">
                                        <span class="product-name">
                                            {{
                                                getProductName(
                                                    product.product_id,
                                                )
                                            }}
                                        </span>
                                        <div class="product-quantities">
                                            <span class="qty-badge qty-given">
                                                Remis:
                                                {{ product.quantity_given }}
                                            </span>
                                            <span
                                                class="qty-badge qty-returned"
                                            >
                                                Déjà retourné:
                                                {{ product.quantity_returned }}
                                            </span>
                                            <span class="qty-badge qty-pending">
                                                En attente:
                                                {{
                                                    product.quantity_given -
                                                    product.quantity_returned
                                                }}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Champ quantité (visible seulement si le produit est sélectionné) -->
                                <div
                                    v-if="
                                        returnData[product.id] &&
                                        returnData[product.id].selected
                                    "
                                    class="quantity-input-section"
                                >
                                    <label class="quantity-label">
                                        Quantité retournée :
                                    </label>
                                    <div class="quantity-input-wrapper">
                                        <input
                                            type="number"
                                            v-model.number="
                                                returnData[product.id].quantity
                                            "
                                            min="0.01"
                                            step="0.01"
                                            :max="
                                                product.quantity_given -
                                                product.quantity_returned
                                            "
                                            class="form-control quantity-field"
                                            placeholder="Quantité"
                                        />
                                        <span class="max-quantity-hint">
                                            Max:
                                            {{
                                                product.quantity_given -
                                                product.quantity_returned
                                            }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Date de retour *</label>
                            <input
                                type="date"
                                v-model="returnDate"
                                class="form-control"
                                required
                            />
                        </div>

                        <div class="form-group">
                            <label>Commentaire</label>
                            <textarea
                                v-model="returnComment"
                                class="form-control"
                                rows="3"
                                placeholder="Remarques sur le retour..."
                            ></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeReturnModal" class="btn-secondary">
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                        <button
                            @click="submitReturn"
                            :disabled="!canSubmitReturn"
                            class="btn-primary"
                        >
                            <i class="fas fa-save"></i>
                            Enregistrer Retour
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal: Supprimer Retour -->
            <div
                v-if="showDeleteReturnModal"
                class="modal-overlay"
                @click.self="closeDeleteReturnModal"
            >
                <div class="modal-container modal-confirm">
                    <div class="modal-header">
                        <h5>
                            <i class="fas fa-exclamation-triangle"></i>
                            Confirmer la suppression du retour
                        </h5>
                    </div>
                    <div class="modal-body">
                        <p>
                            Êtes-vous sûr de vouloir supprimer ce retour de
                            {{ getProductName(returnToDelete?.product_id) }} ?
                        </p>
                        <p v-if="returnToDelete">
                            Quantité:
                            <strong>
                                {{ returnToDelete.quantity_returned }}
                            </strong>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button
                            @click="closeDeleteReturnModal"
                            class="btn-secondary"
                        >
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                        <button @click="deleteReturn" class="btn-danger">
                            <i class="fas fa-trash"></i>
                            Supprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal: Supprimer Transaction -->
            <div
                v-if="showDeleteModal"
                class="modal-overlay"
                @click.self="closeDeleteModal"
            >
                <div class="modal-container modal-confirm">
                    <div class="modal-header">
                        <h5>
                            <i class="fas fa-exclamation-triangle"></i>
                            Confirmer la suppression
                        </h5>
                    </div>
                    <div class="modal-body">
                        <p>
                            Êtes-vous sûr de vouloir supprimer cette opération
                            de remise ?
                        </p>
                        <p v-if="transactionToDelete">
                            <strong>Client :</strong>
                            {{ transactionToDelete.client_name }}
                            <br />
                            <strong>Référence :</strong>
                            {{ transactionToDelete.reference }}
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeDeleteModal" class="btn-secondary">
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                        <button @click="deleteTransaction" class="btn-danger">
                            <i class="fas fa-trash"></i>
                            Supprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal de création de client -->
            <div
                v-if="showCreateCustomerModal"
                class="modal-overlay"
                @click.self="closeCreateCustomerModal"
            >
                <div class="modal-container">
                    <div class="modal-header">
                        <h5>
                            <i class="fas fa-user-plus"></i>
                            Nouveau Client
                        </h5>
                        <button
                            @click="closeCreateCustomerModal"
                            class="modal-close"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="submitNewCustomer">
                            <div class="form-group">
                                <label>Nom du client *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    v-model="newCustomer.name"
                                    placeholder="Nom complet"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Téléphone *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    v-model="newCustomer.phone"
                                    placeholder="Numéro de téléphone"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label>Adresse</label>
                                <textarea
                                    class="form-control"
                                    v-model="newCustomer.address"
                                    placeholder="Adresse complète"
                                    rows="3"
                                ></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button
                            @click="closeCreateCustomerModal"
                            class="btn-secondary"
                        >
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                        <button
                            @click="submitNewCustomer"
                            :disabled="!newCustomer.name || !newCustomer.phone"
                            class="btn-primary"
                        >
                            <i class="fas fa-save"></i>
                            Créer le Client
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</template>

<script>
    export default {
        name: 'ReturnableProductsComponent',
        data() {
            return {
                BASE_URL: 'http://127.0.0.1:8000',
                transactions: [],
                transactionProducts: [],
                stockReturns: [],
                allProducts: [],
                customers: [],
                searchQuery: '',
                filterClient: '',
                filterStatus: '',
                sortOption: 'Date (récent)',
                currentPage: 1,
                itemsPerPage: 10,
                showCreateModal: false,
                showDetailsModal: false,
                showReturnModal: false,
                showDeleteModal: false,
                showDeleteReturnModal: false,
                showCreateCustomerModal: false,
                showNewCustomerDropdown: false,
                selectedTransaction: null,
                transactionToDelete: null,
                returnToDelete: null,
                returnDate: '',
                returnComment: '',
                returnData: {},
                newTransaction: {
                    customerSearch: '',
                    selectedClient: null,
                    productLines: [
                        {
                            selectedProduct: null,
                            searchQuery: '',
                            showDropdown: false,
                            quantity: '',
                        },
                    ],
                    comment: '',
                },
                filteredNewCustomers: [],
                newCustomer: {
                    name: '',
                    phone: '',
                    address: '',
                },
            };
        },

        computed: {
            filteredTransactions() {
                return this.getFilteredTransactions();
            },

            paginatedTransactions() {
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                return this.filteredTransactions.slice(start, end);
            },

            totalPages() {
                return Math.ceil(
                    this.filteredTransactions.length / this.itemsPerPage,
                );
            },

            uniqueClients() {
                const clientMap = new Map();
                this.transactions.forEach((t) => {
                    if (t.client_id && t.client_name) {
                        clientMap.set(t.client_id, {
                            id: t.client_id,
                            name: t.client_name,
                        });
                    }
                });
                return Array.from(clientMap.values());
            },

            canSubmitNewTransaction() {
                if (!this.newTransaction.selectedClient) return false;
                const hasValidLines = this.newTransaction.productLines.some(
                    (line) => line.selectedProduct && line.quantity > 0,
                );
                return hasValidLines;
            },

            canSubmitReturn() {
                return Object.values(this.returnData).some(
                    (data) => data.selected && data.quantity > 0,
                );
            },
        },

        async mounted() {
            await this.fetchAllData();
        },

        methods: {
            async fetchAllData() {
                try {
                    await Promise.all([
                        this.fetchTransactions(),
                        this.fetchTransactionProducts(),
                        this.fetchStockReturns(),
                        this.fetchAllProducts(),
                        this.fetchClients(),
                    ]);
                    console.log('[v0] All data fetched successfully');
                } catch (error) {
                    console.error('[v0] Error fetching data:', error);
                }
            },

            async fetchTransactions() {
                try {
                    const response = await axios.get(
                        `${this.BASE_URL}/returnable-products-transactions`,
                    );
                    this.transactions = response.data;
                    console.log('[v0] Transactions loaded:', this.transactions);
                } catch (error) {
                    console.error('[v0] Error fetching transactions:', error);
                }
            },

            async fetchTransactionProducts() {
                try {
                    const response = await axios.get(
                        `${this.BASE_URL}/returnable-products-list`,
                    );
                    this.transactionProducts = response.data;
                    console.log(
                        '[v0] Transaction products loaded (with quantity_given and quantity_returned from API):',
                        this.transactionProducts,
                    );
                } catch (error) {
                    console.error(
                        '[v0] Error fetching transaction products:',
                        error,
                    );
                }
            },

            async fetchStockReturns() {
                try {
                    const response = await axios.get(
                        `${this.BASE_URL}/returnable-products-returns`,
                    );
                    this.stockReturns = response.data;
                    console.log(
                        '[v0] Stock returns loaded:',
                        this.stockReturns,
                    );
                } catch (error) {
                    console.error('[v0] Error fetching stock returns:', error);
                }
            },

            async fetchAllProducts() {
                try {
                    const response = await axios.get(
                        `${this.BASE_URL}/productsList`,
                    );
                    console.log('[v0] Products fetched:', response.data);
                    this.allProducts = Array.isArray(response.data)
                        ? response.data
                        : [];
                } catch (error) {
                    console.error('[v0] Error fetching products:', error);
                    this.allProducts = [];
                }
            },

            async fetchClients() {
                try {
                    const response = await axios.get(
                        `${this.BASE_URL}/clientslist`,
                    );
                    this.customers = response.data;
                } catch (error) {
                    console.error('[v0] Error fetching clients:', error);
                }
            },

            // Filter & Search Methods
            getFilteredTransactions() {
                let filtered = this.transactions;

                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    filtered = filtered.filter(
                        (t) =>
                            t.client_name.toLowerCase().includes(query) ||
                            t.reference.toLowerCase().includes(query) ||
                            this.getProductsForTransaction(t.id).some((p) =>
                                this.getProductName(p.product_id)
                                    .toLowerCase()
                                    .includes(query),
                            ),
                    );
                }

                if (this.filterClient) {
                    filtered = filtered.filter(
                        (t) => t.client_id === parseInt(this.filterClient),
                    );
                }

                if (this.filterStatus) {
                    filtered = filtered.filter(
                        (t) =>
                            this.getTransactionStatus(t) === this.filterStatus,
                    );
                }

                return this.sortTransactions(filtered);
            },

            sortTransactions(transactions) {
                const sorted = [...transactions];
                switch (this.sortOption) {
                    case 'Date (ancien)':
                        return sorted.sort(
                            (a, b) => new Date(a.date) - new Date(b.date),
                        );
                    case 'Client (A-Z)':
                        return sorted.sort((a, b) =>
                            a.client_name.localeCompare(b.client_name),
                        );
                    case 'Quantité restante (croissant)':
                        return sorted.sort(
                            (a, b) =>
                                parseFloat(this.getTotalQuantityPending(a.id)) -
                                parseFloat(this.getTotalQuantityPending(b.id)),
                        );
                    case 'Quantité restante (décroissant)':
                        return sorted.sort(
                            (a, b) =>
                                parseFloat(this.getTotalQuantityPending(b.id)) -
                                parseFloat(this.getTotalQuantityPending(a.id)),
                        );
                    default:
                        return sorted.sort(
                            (a, b) => new Date(b.date) - new Date(a.date),
                        );
                }
            },

            // Data Retrieval Methods
            getProductsForTransaction(transactionId) {
                return this.transactionProducts.filter(
                    (p) => p.returnable_product_id === transactionId,
                );
            },

            getProductsForReturn(transactionId) {
                const allProducts =
                    this.getProductsForTransaction(transactionId);
                const productsWithPendingQuantity = allProducts.filter((p) => {
                    const quantityGiven = parseFloat(p.quantity_given) || 0;
                    const quantityReturned =
                        parseFloat(p.quantity_returned) || 0;
                    const hasPending = quantityGiven > quantityReturned;

                    console.log(
                        `[v0] getProductsForReturn - Product ${p.id} (${this.getProductName(p.product_id)}): Given=${quantityGiven}, Returned=${quantityReturned}, Has Pending=${hasPending}`,
                    );

                    return hasPending;
                });

                console.log(
                    `[v0] getProductsForReturn - Transaction ${transactionId}: ${productsWithPendingQuantity.length} products with pending returns out of ${allProducts.length} total`,
                );

                return productsWithPendingQuantity;
            },

            getReturnsForTransaction(transactionId) {
                const productIds = this.getProductsForTransaction(
                    transactionId,
                ).map((p) => p.id);
                return this.stockReturns.filter((r) =>
                    productIds.includes(r.returnable_product_id),
                );
            },

            getProductCountForTransaction(transactionId) {
                return this.getProductsForTransaction(transactionId).length;
            },

            getTotalQuantityGiven(transactionId) {
                return this.getProductsForTransaction(transactionId)
                    .reduce(
                        (sum, p) => sum + (parseFloat(p.quantity_given) || 0),
                        0,
                    )
                    .toFixed(2);
            },

            getTotalQuantityReturned(transactionId) {
                return this.getProductsForTransaction(transactionId)
                    .reduce(
                        (sum, p) =>
                            sum + (parseFloat(p.quantity_returned) || 0),
                        0,
                    )
                    .toFixed(2);
            },

            getTotalQuantityPending(transactionId) {
                const given =
                    parseFloat(this.getTotalQuantityGiven(transactionId)) || 0;
                const returned =
                    parseFloat(this.getTotalQuantityReturned(transactionId)) ||
                    0;
                return (given - returned).toFixed(2);
            },

            getProductName(productId) {
                if (!Array.isArray(this.allProducts)) {
                    console.error(
                        '[v0] allProducts is not an array:',
                        this.allProducts,
                    );
                    return 'Produit inconnu';
                }
                const product = this.allProducts.find(
                    (p) => p.id === productId,
                );

                if (!product) {
                    console.warn(
                        `[v0] Product with ID ${productId} not found in allProducts`,
                    );
                }

                return product ? product.name : `Produit #${productId} inconnu`;
            },

            // Status Methods
            getTransactionStatus(transaction) {
                const pending =
                    parseFloat(this.getTotalQuantityPending(transaction.id)) ||
                    0;
                const given =
                    parseFloat(this.getTotalQuantityGiven(transaction.id)) || 0;

                if (pending === 0 && given > 0) return 'complete';
                if (
                    parseFloat(this.getTotalQuantityReturned(transaction.id)) >
                    0
                )
                    return 'partial';
                return 'pending';
            },

            getTransactionStatusText(transaction) {
                switch (this.getTransactionStatus(transaction)) {
                    case 'complete':
                        return 'Complètement retourné';
                    case 'partial':
                        return 'Partiellement retourné';
                    default:
                        return 'Non retourné';
                }
            },

            getTransactionStatusBadgeStyle(transaction) {
                const status = this.getTransactionStatus(transaction);
                const styles = {
                    complete: {
                        bg: '#e8f5e9',
                        color: '#388e3c',
                        border: '#a5d6a7',
                    },
                    partial: {
                        bg: '#fff3e0',
                        color: '#f57c00',
                        border: '#ffcc80',
                    },
                    pending: {
                        bg: '#ffebee',
                        color: '#c62828',
                        border: '#ef9a9a',
                    },
                };
                const style = styles[status] || styles.pending;
                return {
                    backgroundColor: style.bg,
                    color: style.color,
                    border: `1px solid ${style.border}`,
                    padding: '0.4rem 0.8rem',
                    borderRadius: '20px',
                    fontSize: '0.85rem',
                    fontWeight: '600',
                    display: 'inline-block',
                };
            },

            getTransactionRowClass(transaction) {
                const status = this.getTransactionStatus(transaction);
                return `row-${status}`;
            },

            getProductStatusText(product) {
                const quantityReturned =
                    parseFloat(product.quantity_returned) || 0;
                if (parseFloat(product.quantity_given) === quantityReturned)
                    return 'Complètement retourné';
                if (quantityReturned > 0) return 'Partiellement retourné';
                return 'Non retourné';
            },

            getProductStatusBadgeStyle(product) {
                const quantityReturned =
                    parseFloat(product.quantity_returned) || 0;
                const pending =
                    parseFloat(product.quantity_given) - quantityReturned;
                const styles = {
                    complete: {
                        bg: '#e8f5e9',
                        color: '#388e3c',
                        border: '#a5d6a7',
                    },
                    partial: {
                        bg: '#fff3e0',
                        color: '#f57c00',
                        border: '#ffcc80',
                    },
                    pending: {
                        bg: '#ffebee',
                        color: '#c62828',
                        border: '#ef9a9a',
                    },
                };

                let status = 'pending';
                if (pending === 0) status = 'complete';
                else if (quantityReturned > 0) status = 'partial';

                const style = styles[status];
                return {
                    backgroundColor: style.bg,
                    color: style.color,
                    border: `1px solid ${style.border}`,
                    padding: '0.3rem 0.6rem',
                    borderRadius: '12px',
                    fontSize: '0.8rem',
                    fontWeight: '600',
                    display: 'inline-block',
                };
            },

            openCreateTransactionModal() {
                this.newTransaction = {
                    customerSearch: '',
                    selectedClient: null,
                    productLines: [
                        {
                            selectedProduct: null,
                            searchQuery: '',
                            showDropdown: false,
                            quantity: '',
                        },
                    ],
                    comment: '',
                };
                this.filteredNewCustomers = [...this.customers];
                this.showCreateModal = true;
            },

            closeCreateModal() {
                this.showCreateModal = false;
                this.newTransaction.customerSearch = '';
                this.newTransaction.selectedClient = null;
            },

            openDetailsModal(transaction) {
                this.selectedTransaction = transaction;
                this.showDetailsModal = true;
            },

            closeDetailsModal() {
                this.showDetailsModal = false;
                this.selectedTransaction = null;
            },

            openRecordReturnModal(transaction) {
                this.selectedTransaction = transaction;
                this.returnDate = new Date().toISOString().split('T')[0];
                this.returnComment = '';

                // Initialiser returnData avec tous les produits disponibles pour le retour
                const productsForReturn = this.getProductsForReturn(
                    transaction.id,
                );
                console.log(
                    `[v0] openRecordReturnModal - Products available for return:`,
                    productsForReturn,
                );

                const newReturnData = {};
                productsForReturn.forEach((product) => {
                    if (product && product.id !== undefined) {
                        const quantityGiven =
                            parseFloat(product.quantity_given) || 0;
                        const quantityReturned =
                            parseFloat(product.quantity_returned) || 0;
                        const maxQuantity = quantityGiven - quantityReturned;

                        newReturnData[product.id] = {
                            selected: false,
                            quantity: 0,
                            product_id: product.product_id,
                            product_name: this.getProductName(
                                product.product_id,
                            ),
                            max_quantity: maxQuantity,
                            quantity_given: quantityGiven,
                            quantity_returned: quantityReturned,
                        };

                        console.log(
                            `[v0]   - Product ${product.id} (${this.getProductName(product.product_id)}): Max returnable = ${maxQuantity}`,
                        );
                    }
                });
                this.returnData = newReturnData;

                console.log('[v0] Return data initialized:', this.returnData);
                this.showReturnModal = true;
            },

            closeReturnModal() {
                this.showReturnModal = false;
                this.selectedTransaction = null;
                this.returnData = {};
            },

            onProductSelectionChange(productId) {
                // Si le produit est désélectionné, remettre la quantité à 0
                if (!this.returnData[productId].selected) {
                    this.returnData[productId].quantity = 0;
                }
            },

            openEditReturnModal(returnItem) {
                console.log('[v0] Edit return:', returnItem);
            },

            openDeleteReturnModal(returnItem) {
                this.returnToDelete = returnItem;
                this.showDeleteReturnModal = true;
            },

            closeDeleteReturnModal() {
                this.showDeleteReturnModal = false;
                this.returnToDelete = null;
            },

            openDeleteModal(transaction) {
                this.transactionToDelete = transaction;
                this.showDeleteModal = true;
            },

            closeDeleteModal() {
                this.showDeleteModal = false;
                this.transactionToDelete = null;
            },

            // Customer Search
            filterNewTransactionCustomers() {
                const query = this.newTransaction.customerSearch.toLowerCase();
                if (!query) {
                    this.filteredNewCustomers = [...this.customers];
                } else {
                    this.filteredNewCustomers = this.customers.filter(
                        (c) =>
                            c.name.toLowerCase().includes(query) ||
                            c.phone.includes(query),
                    );
                }
                this.showNewCustomerDropdown = true;
            },

            selectNewTransactionCustomer(client) {
                this.newTransaction.selectedClient = client;
                this.newTransaction.customerSearch = client.name;
                this.showNewCustomerDropdown = false;
            },

            openCreateCustomerModal() {
                this.newCustomer.name = this.newTransaction.customerSearch;
                this.newCustomer.phone = '';
                this.newCustomer.address = '';
                this.showCreateCustomerModal = true;
                this.showNewCustomerDropdown = false;
            },

            closeCreateCustomerModal() {
                this.showCreateCustomerModal = false;
                this.newCustomer = {
                    name: '',
                    phone: '',
                    address: '',
                };
            },

            async submitNewCustomer() {
                if (!this.newCustomer.name || !this.newCustomer.phone) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }

                try {
                    const response = await axios.post(
                        `${this.BASE_URL}/clients`,
                        {
                            name: this.newCustomer.name,
                            phone: this.newCustomer.phone,
                            address: this.newCustomer.address,
                        },
                    );

                    if (response.data.success) {
                        alert('Client créé avec succès');
                        await this.fetchClients();

                        const newClient = this.customers.find(
                            (c) =>
                                c.name === this.newCustomer.name &&
                                c.phone === this.newCustomer.phone,
                        );
                        if (newClient) {
                            this.selectNewTransactionCustomer(newClient);
                        }

                        this.closeCreateCustomerModal();
                    } else {
                        alert(
                            response.data.message ||
                                'Erreur lors de la création du client',
                        );
                    }
                } catch (error) {
                    console.error('Error creating customer:', error);
                    alert(
                        'Erreur lors de la création du client: ' +
                            (error.response?.data?.message || error.message),
                    );
                }
            },

            // Product Search
            onProductSearch(index) {
                this.newTransaction.productLines[index].showDropdown = true;
            },

            getFilteredReturnableProducts(index) {
                const query =
                    this.newTransaction.productLines[
                        index
                    ].searchQuery.toLowerCase();
                const selectedProductIds = this.newTransaction.productLines
                    .filter((_, i) => i !== index && _.selectedProduct)
                    .map((line) => line.selectedProduct.id);

                if (!Array.isArray(this.allProducts)) {
                    return [];
                }

                return this.allProducts.filter(
                    (p) =>
                        p.name.toLowerCase().includes(query) &&
                        !selectedProductIds.includes(p.id) &&
                        p.isReturnable === 1,
                );
            },

            selectProductForLine(index, product) {
                this.newTransaction.productLines[index].selectedProduct =
                    product;
                this.newTransaction.productLines[index].searchQuery =
                    product.name;
                this.newTransaction.productLines[index].showDropdown = false;
            },

            addProductLine() {
                this.newTransaction.productLines.push({
                    selectedProduct: null,
                    searchQuery: '',
                    showDropdown: false,
                    quantity: 0,
                });
            },

            removeProductLine(index) {
                this.newTransaction.productLines.splice(index, 1);
            },

            // Form Submissions
            async submitNewTransaction() {
                if (!this.canSubmitNewTransaction) {
                    alert('Veuillez compléter le formulaire');
                    return;
                }

                const products = this.newTransaction.productLines
                    .filter((l) => l.selectedProduct && l.quantity > 0)
                    .map((l) => ({
                        product_id: l.selectedProduct.id,
                        quantity_given: Number(l.quantity),
                    }));

                const now = new Date();
                const formatter = new Intl.DateTimeFormat('sv-SE', {
                    timeZone: 'Africa/Lagos',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                });
                const datetime = formatter.format(now).replace('T', ' ');

                const reference = `REM-${datetime
                    .slice(0, 10)
                    .replace(/-/g, '')}-${Math.random()
                    .toString(36)
                    .slice(2, 5)
                    .toUpperCase()}`;

                const payload = {
                    client_id: this.newTransaction.selectedClient.id,
                    date: datetime,
                    comment: this.newTransaction.comment,
                    reference,
                    items: products,
                };

                // 🔹 LOG de débogage
                console.log(
                    '[DEBUG] Route:',
                    `${this.BASE_URL}/returnable-products`,
                );
                console.log(
                    '[DEBUG] Payload envoyé:',
                    JSON.stringify(payload, null, 2),
                );

                try {
                    const response = await axios.post(
                        `${this.BASE_URL}/returnable-products`,
                        payload,
                    );

                    // 🔹 LOG de la réponse
                    console.log('[DEBUG] Réponse API:', response.data);

                    if (response.data.success) {
                        alert('Remise enregistrée');
                        this.closeCreateModal();
                        await this.fetchAllData();
                    } else {
                        alert(response.data.message || 'Erreur serveur');
                    }
                } catch (error) {
                    console.error(
                        '[ERROR REMISE]',
                        error.response?.data || error,
                    );
                    alert(error.response?.data?.message || error.message);
                }
            },
            async submitReturn() {
                if (!this.canSubmitReturn) {
                    alert(
                        'Veuillez sélectionner au moins un produit et entrer une quantité à retourner',
                    );
                    return;
                }

                const selectedItems = Object.entries(this.returnData)
                    .filter(([_, data]) => data.selected && data.quantity > 0)
                    .map(([transactionProductId, data]) => {
                        const product = this.getProductsForReturn(
                            this.selectedTransaction.id,
                        ).find((p) => p.id === parseInt(transactionProductId));

                        // Récupérer le returnable_product_id (id de la ligne dans returnable_products_list)
                        return {
                            returnable_product_id: product.id,
                            product_id: product.product_id,
                            quantity_returned: data.quantity,
                        };
                    });

                if (selectedItems.length === 0) {
                    alert('Aucune quantité à retourner sélectionnée.');
                    return;
                }

                const payload = {
                    returnable_product_id: this.selectedTransaction.id,
                    date: this.returnDate,
                    comment: this.returnComment,
                    items: selectedItems,
                };

                try {
                    const route = `${this.BASE_URL}/returnable-products-returns`;
                    console.log('[v0] REQUEST: POST - Route:', route);
                    console.log('[v0] PAYLOAD:', payload);

                    const response = await axios.post(route, payload);

                    console.log('[v0] RESPONSE: Return recorded', {
                        status: response.status,
                        data: response.data,
                    });

                    alert('Retours enregistrés avec succès');
                    this.closeReturnModal();
                    await this.fetchAllData();
                } catch (error) {
                    console.error('[v0] ERROR submitting returns:', {
                        route: `${this.BASE_URL}/returnable-products-returns`,
                        payload,
                        error: error.message,
                        response: error.response?.data,
                    });

                    alert(
                        "Erreur lors de l'enregistrement des retours: " +
                            (error.response?.data?.message || error.message),
                    );
                }
            },
            async deleteReturn() {
                if (!this.returnToDelete) return;

                try {
                    await axios.delete(
                        `${this.BASE_URL}/returnable-products-returns/${this.returnToDelete.id}`,
                    );
                    alert('Retour supprimé avec succès');
                    this.closeDeleteReturnModal();
                    await this.fetchAllData();
                } catch (error) {
                    console.error('[v0] Error deleting return:', error);
                    alert(
                        'Erreur lors de la suppression: ' +
                            (error.response?.data?.message || error.message),
                    );
                }
            },

            async deleteTransaction() {
                if (!this.transactionToDelete) return;

                try {
                    await axios.delete(
                        `${this.BASE_URL}/returnable-products-transactions/${this.transactionToDelete.id}`,
                    );
                    alert('Opération supprimée avec succès');
                    this.closeDeleteModal();
                    await this.fetchAllData();
                } catch (error) {
                    console.error('[v0] Error deleting transaction:', error);
                    alert(
                        'Erreur lors de la suppression: ' +
                            (error.response?.data?.message || error.message),
                    );
                }
            },

            formatDate(date) {
                if (!date) return 'N/A';
                const d = new Date(date);
                return d.toLocaleDateString('fr-FR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                });
            },

            printAll() {
                const printWindow = window.open('', '', 'height=600,width=900');
                const transactionsHtml = this.generatePrintHtml(
                    this.paginatedTransactions,
                );
                printWindow.document.write(transactionsHtml);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            },

            printTransaction(transaction) {
                const products = this.getProductsForTransaction(transaction.id);
                const printWindow = window.open('', '', 'height=600,width=900');
                const html = this.generateTransactionPrintHtml(
                    transaction,
                    products,
                );
                printWindow.document.write(html);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, 250);
            },

            generatePrintHtml(transactions) {
                let html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Produits avec Emballages - Impression</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h1 { text-align: center; margin-bottom: 20px; color: #333; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                            th { background: #667eea; color: white; font-weight: bold; }
                            tr:hover { background: #f5f5f5; }
                            .status-badge { 
                                padding: 4px 8px; 
                                border-radius: 4px; 
                                font-size: 12px; 
                                font-weight: bold;
                            }
                            .status-pending { background: #fff3cd; color: #856404; }
                            .status-partial { background: #cfe2ff; color: #084298; }
                            .status-complete { background: #d1e7dd; color: #0f5132; }
                            .qty-center { text-align: center; }
                            @media print {
                                body { padding: 10px; }
                                table { page-break-inside: avoid; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>📦 Gestion des Produits avec Emballages</h1>
                        <p style="text-align: center; margin-bottom: 20px;">
                            Remise et retour des produits consignés - ${new Date().toLocaleDateString('fr-FR')}
                        </p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Référence</th>
                                    <th>Date Remise</th>
                                    <th>Produits</th>
                                    <th class="qty-center">Qté Remise</th>
                                    <th class="qty-center">Qté Retournée</th>
                                    <th class="qty-center">En Attente</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                transactions.forEach((trans) => {
                    const status = this.getTransactionStatusText(trans);
                    const statusClass = status.includes('Non')
                        ? 'status-pending'
                        : status.includes('Partiellement')
                          ? 'status-partial'
                          : 'status-complete';
                    html += `
                        <tr>
                            <td><strong>${trans.client_name}</strong></td>
                            <td>${trans.reference}</td>
                            <td>${this.formatDate(trans.date)}</td>
                            <td>${this.getProductCountForTransaction(trans.id)} produit(s)</td>
                            <td class="qty-center">${this.getTotalQuantityGiven(trans.id)}</td>
                            <td class="qty-center">${this.getTotalQuantityReturned(trans.id)}</td>
                            <td class="qty-center">${this.getTotalQuantityPending(trans.id)}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </body>
                    </html>
                `;
                return html;
            },

            generateTransactionPrintHtml(transaction, products) {
                const now = new Date().toLocaleDateString('fr-FR');
                let html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Détail Remise - ${transaction.reference}</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .header { 
                                display: flex; 
                                justify-content: space-between; 
                                margin-bottom: 30px;
                                border-bottom: 2px solid #667eea;
                                padding-bottom: 15px;
                            }
                            .company-info { }
                            .transaction-info { text-align: right; }
                            h1 { color: #333; margin-bottom: 10px; }
                            h2 { color: #667eea; margin-top: 20px; margin-bottom: 10px; font-size: 16px; }
                            .info-row { 
                                display: flex; 
                                margin-bottom: 8px;
                                gap: 20px;
                            }
                            .info-label { font-weight: bold; min-width: 120px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; margin-top: 10px; }
                            th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                            th { background: #667eea; color: white; font-weight: bold; }
                            tr:hover { background: #f9f9f9; }
                            .qty-column { text-align: center; }
                            .total-row { font-weight: bold; background: #f0f0f0; }
                            .print-note { 
                                margin-top: 20px; 
                                padding: 10px; 
                                background: #f5f5f5; 
                                border-left: 4px solid #667eea;
                                font-size: 12px;
                            }
                            @media print {
                                body { padding: 10px; }
                                .header { page-break-inside: avoid; }
                                table { page-break-inside: avoid; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="company-info">
                                <h1>📦 Remise de Produits</h1>
                                <p>Gestion des produits consignés</p>
                            </div>
                            <div class="transaction-info">
                                <p><strong>Date d'impression:</strong> ${now}</p>
                            </div>
                        </div>

                        <h2>Informations de la Transaction</h2>
                        <div class="info-row">
                            <div><span class="info-label">Client:</span> <strong>${transaction.client_name}</strong></div>
                            <div><span class="info-label">Référence:</span> <strong>${transaction.reference}</strong></div>
                        </div>
                        <div class="info-row">
                            <div><span class="info-label">Date remise:</span> <strong>${this.formatDate(transaction.date)}</strong></div>
                        </div>

                        <h2>Détails des Produits</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th class="qty-column">Quantité Remise</th>
                                    <th class="qty-column">Quantité Retournée</th>
                                    <th class="qty-column">En Attente</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                let totalGiven = 0;
                let totalReturned = 0;

                products.forEach((product) => {
                    const pending =
                        parseFloat(product.quantity_given) -
                        parseFloat(product.quantity_returned);
                    totalGiven += parseFloat(product.quantity_given);
                    totalReturned += parseFloat(product.quantity_returned);

                    html += `
                        <tr>
                            <td>${product.product_name}</td>
                            <td class="qty-column">${product.quantity_given}</td>
                            <td class="qty-column">${product.quantity_returned}</td>
                            <td class="qty-column">${pending.toFixed(2)}</td>
                        </tr>
                    `;
                });

                const totalPending = (totalGiven - totalReturned).toFixed(2);
                html += `
                        <tr class="total-row">
                            <td>TOTAL</td>
                            <td class="qty-column">${totalGiven.toFixed(2)}</td>
                            <td class="qty-column">${totalReturned.toFixed(2)}</td>
                            <td class="qty-column">${totalPending}</td>
                        </tr>
                            </tbody>
                        </table>

                        <div class="print-note">
                            <p><strong>Note:</strong> Ce document a été généré depuis le système de gestion des produits consignés.</p>
                            <p>Assurez-vous que tous les produits sont correctement enregistrés avant d'imprimer.</p>
                        </div>
                    </body>
                    </html>
                `;
                return html;
            },
        },
    };
</script>

<style scoped>
    /* Reset global pour éliminer le défilement horizontal */
    * {
        box-sizing: border-box;
    }

    /* Button Styles */
    .btn-eye {
        background: #17a2b8;
        color: white;
    }

    .btn-eye:hover {
        background: #138496;
    }

    .btn-reply {
        background: #28a745;
        color: white;
    }

    .btn-reply:hover {
        background: #218838;
    }

    .btn-print {
        background: #6c757d;
        color: white;
    }

    .btn-print:hover {
        background: #5a6268;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .btn-delete:hover {
        background: #c82333;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-action {
        background: #ffc107;
        color: #333;
    }

    .btn-action:hover {
        background: #e0a800;
    }

    /* Correction du layout principal - suppression de l'espace à gauche */
    .main-content {
        width: 100%;
        max-width: 100%;
        background: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
        margin: 0;
        overflow-x: hidden;
    }

    /* Centrage correct du contenu sans espace à gauche */
    .returnables-content {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0;
    }

    /* Header Section */
    .header-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-header {
        margin-bottom: 0;
    }

    .section-header h2 {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 24px;
        flex-wrap: wrap;
    }

    /* Controls Section */
    .controls-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .search-filters {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
    }

    .search-box {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .search-input {
        width: 100%;
        padding: 10px 40px 10px 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
    }

    .search-box i {
        position: absolute;
        right: 15px;
        color: #999;
        pointer-events: none;
    }

    .filters-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
        width: 100%;
    }

    .select-filter {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        width: 100%;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-primary,
    .btn-secondary {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: #5568d3;
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #f0f0f0;
        color: #333;
        border: 1px solid #ddd;
    }

    .btn-secondary:hover {
        background: #e8e8e8;
    }

    /* Table Section - correction du overflow */
    .table-container {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        width: 100%;
    }

    .table-wrapper {
        overflow-x: auto;
        width: 100%;
        -webkit-overflow-scrolling: touch;
    }

    .products-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: auto;
    }

    .products-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .products-table th {
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        white-space: nowrap;
    }

    .products-table td {
        padding: 12px 8px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
    }

    .products-table tbody tr {
        transition: background 0.2s;
    }

    .products-table tbody tr:hover {
        background: #f9f9f9;
    }

    .row-complete {
        border-left: 4px solid #28a745;
    }

    .row-partial {
        border-left: 4px solid #ffc107;
    }

    .row-pending {
        border-left: 4px solid #dc3545;
    }

    .qty-center {
        text-align: center !important;
    }

    .pending-qty {
        font-weight: bold;
        color: #dc3545;
    }

    .reference {
        font-family: monospace;
        font-size: 12px;
        color: #666;
    }

    .product-count-badge {
        background: #e7f3ff;
        color: #0066cc;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
    }

    .actions-cell {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .btn-small {
        padding: 6px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .empty-row {
        height: 200px;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
        flex-wrap: wrap;
    }

    .btn-pagination {
        padding: 8px 16px;
        border: 1px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .btn-pagination:hover:not(:disabled) {
        background: #667eea;
        color: white;
    }

    .btn-pagination:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-info {
        color: #666;
        font-size: 14px;
        font-weight: 500;
    }

    /* Button create customer */
    .btn-create-customer {
        margin-top: 10px;
        padding: 10px 15px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        width: 100%;
        justify-content: center;
    }

    .btn-create-customer:hover {
        background: #5568d3;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-container {
        background: white;
        border-radius: 8px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-large {
        max-width: 900px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #ddd;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
    }

    .modal-header h5 {
        margin: 0;
        color: #333;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 30px;
        height: 30px;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding: 20px;
        border-top: 1px solid #ddd;
        position: sticky;
        bottom: 0;
        background: white;
    }

    /* Form Styles */
    .form-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f0f0f0;
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }

    .customer-search-container {
        position: relative;
    }

    .customer-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 100;
    }

    .customer-dropdown-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }

    .customer-dropdown-item:hover {
        background: #f9f9f9;
    }

    .customer-item-name {
        font-weight: 600;
        color: #333;
    }

    .customer-item-phone {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
    }

    .selected-client-info {
        background: #f0f7ff;
        padding: 15px;
        border-radius: 6px;
        margin-top: 10px;
        border-left: 4px solid #667eea;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
        flex-wrap: wrap;
        gap: 5px;
    }

    .info-label {
        font-weight: 600;
        color: #333;
    }

    .info-value {
        color: #666;
    }

    /* Product Lines */
    .products-list {
        background: #fafafa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .product-line-form {
        background: white;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }

    .product-line-form:last-child {
        margin-bottom: 0;
    }

    .product-line-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
        flex-wrap: wrap;
        gap: 10px;
    }

    .line-number {
        font-weight: 600;
        color: #333;
    }

    .btn-remove-line {
        padding: 6px 12px;
        background: #ffe7e7;
        color: #dc3545;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
    }

    .btn-remove-line:hover {
        background: #ffcccc;
    }

    .product-search-container {
        position: relative;
    }

    .product-search-input {
        width: 100%;
    }

    .product-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 100;
    }

    .product-dropdown-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }

    .product-dropdown-item:hover {
        background: #f9f9f9;
    }

    .product-item-name {
        font-weight: 600;
        color: #333;
    }

    .product-item-stock {
        font-size: 12px;
        color: #0066cc;
        margin-top: 2px;
    }

    .quantity-input-group {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .quantity-input {
        flex: 1;
        min-width: 100px;
    }

    .quantity-info {
        font-size: 12px;
        color: #999;
        white-space: nowrap;
    }

    .btn-add-line {
        padding: 10px 20px;
        background: #e7f3ff;
        color: #0066cc;
        border: 1px solid #cce5ff;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .btn-add-line:hover {
        background: #cce5ff;
    }

    /* Details Modal */
    .details-header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .detail-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .detail-label {
        font-weight: 600;
        color: #333;
        font-size: 13px;
    }

    .detail-value {
        color: #666;
        font-size: 14px;
    }

    .details-table-section {
        margin-bottom: 30px;
        overflow-x: auto;
    }

    .details-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 400px;
    }

    .details-table thead {
        background: #f9f9f9;
    }

    .details-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 1px solid #ddd;
        white-space: nowrap;
    }

    .details-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
    }

    /* Styles améliorés pour le modal de retour */
    .return-info-section {
        background: #f0f7ff;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
    }

    .products-for-return {
        margin-bottom: 20px;
    }

    .no-products-message {
        text-align: center;
        padding: 30px;
        color: #28a745;
        background: #e8f5e9;
        border-radius: 6px;
    }

    .no-products-message i {
        font-size: 2rem;
        margin-bottom: 10px;
        display: block;
    }

    .return-product-item {
        background: #fafafa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        border: 2px solid transparent;
        transition: all 0.2s;
    }

    .return-product-item.selected {
        border-color: #667eea;
        background: #f0f7ff;
    }

    .product-selection-row {
        display: flex;
        align-items: flex-start;
        gap: 15px;
    }

    /* Checkbox custom styles */
    .checkbox-container {
        display: flex;
        align-items: center;
        position: relative;
        cursor: pointer;
        user-select: none;
        padding-top: 3px;
    }

    .checkbox-container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .checkmark {
        height: 22px;
        width: 22px;
        background-color: #fff;
        border: 2px solid #ddd;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .checkbox-container:hover input ~ .checkmark {
        border-color: #667eea;
    }

    .checkbox-container input:checked ~ .checkmark {
        background-color: #667eea;
        border-color: #667eea;
    }

    .checkmark:after {
        content: '';
        position: absolute;
        display: none;
    }

    .checkbox-container input:checked ~ .checkmark:after {
        display: block;
    }

    .checkbox-container .checkmark:after {
        left: 8px;
        top: 4px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    .product-info-block {
        flex: 1;
    }

    .product-name {
        font-weight: 600;
        color: #333;
        font-size: 15px;
        display: block;
        margin-bottom: 8px;
    }

    .product-quantities {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .qty-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .qty-given {
        background: #e3f2fd;
        color: #1976d2;
    }

    .qty-returned {
        background: #e8f5e9;
        color: #388e3c;
    }

    .qty-pending {
        background: #fff3e0;
        color: #f57c00;
    }

    .quantity-input-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #ddd;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .quantity-label {
        font-weight: 500;
        color: #333;
        font-size: 14px;
        white-space: nowrap;
    }

    .quantity-input-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 200px;
    }

    .quantity-field {
        width: 120px;
        padding: 8px 12px;
    }

    .max-quantity-hint {
        font-size: 12px;
        color: #999;
        white-space: nowrap;
    }

    /* Confirmation Modal */
    .modal-confirm {
        max-width: 400px;
    }

    .modal-confirm .modal-body {
        padding: 30px;
        text-align: center;
    }

    .modal-confirm p {
        margin-bottom: 10px;
        color: #666;
    }

    .modal-confirm strong {
        color: #333;
    }

    /* Responsive amélioré */
    @media (max-width: 1024px) {
        .products-table th,
        .products-table td {
            padding: 10px 6px;
            font-size: 12px;
        }

        .filters-group {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 10px;
        }

        .header-section {
            padding: 15px;
        }

        .section-header h2 {
            font-size: 18px;
        }

        .controls-section {
            padding: 15px;
        }

        .filters-group {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }

        .btn-primary,
        .btn-secondary {
            width: 100%;
            justify-content: center;
        }

        .table-container {
            padding: 10px;
        }

        .products-table {
            font-size: 12px;
        }

        .products-table th {
            display: none;
        }

        .products-table tbody tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        .products-table td {
            display: block;
            text-align: right;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
            padding-left: 50%;
        }

        .products-table td[data-label]:before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            font-weight: 600;
            color: #667eea;
            text-align: left;
        }

        .products-table td:first-child {
            background: #f9f9f9;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
        }

        .products-table tbody tr:last-child td {
            border-bottom: none;
        }

        .row-complete {
            border-left: none;
            border-top: 4px solid #28a745;
        }

        .row-partial {
            border-left: none;
            border-top: 4px solid #ffc107;
        }

        .row-pending {
            border-left: none;
            border-top: 4px solid #dc3545;
        }

        .qty-center {
            text-align: right !important;
        }

        .pending-qty {
            font-weight: bold;
            color: #dc3545;
        }

        .reference {
            font-family: monospace;
            font-size: 11px;
        }

        .actions-cell {
            display: flex;
            flex-direction: row;
            gap: 5px;
            text-align: right;
            padding-left: 50%;
        }

        .actions-cell[data-label]:before {
            left: 10px;
        }

        .btn-small {
            padding: 5px 8px;
            font-size: 10px;
            flex: 1;
            min-width: 40px;
        }

        .product-count-badge {
            display: inline-block;
        }

        .modal-container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            border-radius: 0;
            max-height: 100vh;
        }

        .modal-overlay {
            padding: 0;
        }

        .pagination {
            flex-wrap: wrap;
            gap: 10px;
        }

        .pagination-info {
            width: 100%;
            text-align: center;
            order: -1;
        }

        .details-header {
            grid-template-columns: 1fr;
        }

        .product-selection-row {
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-container {
            order: -1;
        }

        .quantity-input-section {
            flex-direction: column;
            align-items: flex-start;
        }

        .quantity-input-wrapper {
            width: 100%;
        }
    }

    @media (max-width: 480px) {
        .main-content {
            padding: 8px;
        }

        .header-section {
            padding: 12px;
        }

        .section-header h2 {
            font-size: 16px;
        }

        .controls-section {
            padding: 12px;
        }

        .search-filters {
            gap: 10px;
        }

        .search-input {
            padding: 8px 35px 8px 12px;
            font-size: 13px;
        }

        .select-filter {
            padding: 8px 10px;
            font-size: 12px;
        }

        .products-table {
            font-size: 11px;
        }

        .products-table td {
            padding: 8px;
            padding-left: 45%;
        }

        .products-table td[data-label]:before {
            font-size: 11px;
            left: 8px;
        }

        .btn-small {
            padding: 4px 6px;
            font-size: 9px;
            min-width: 35px;
        }

        .modal-header h5 {
            font-size: 16px;
        }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            gap: 8px;
            padding: 15px;
            flex-direction: column;
        }

        .modal-footer button {
            width: 100%;
        }

        .form-control {
            padding: 8px 10px;
            font-size: 13px;
        }

        .product-line-header {
            gap: 8px;
        }

        .product-quantities {
            flex-wrap: wrap;
            gap: 5px;
        }

        .qty-badge {
            padding: 3px 8px;
            font-size: 11px;
        }
    }

    .quantity-field {
        flex: 1;
        width: 100%;
    }

    .product-quantities {
        flex-direction: column;
        gap: 5px;
    }
</style>
